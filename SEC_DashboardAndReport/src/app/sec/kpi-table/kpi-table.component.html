<div class="kpi-page-container">
  <h2 class="page-title">{{ kpiLabel }}</h2>
  <p class="page-description">View and manage KPIs with advanced filtering and editing capabilities</p>

  <!-- Dynamic Filters Section -->
  <div class="filters-section" *ngIf="kpiFilters.length > 0">
    <mat-form-field appearance="outline" class="filter-field" *ngFor="let filter of kpiFilters">
      <mat-label>{{ filter.label }}</mat-label>
      <mat-select [(value)]="filterValues[filter.key]" (selectionChange)="onFilterChange(filter.key)">
        <mat-option *ngFor="let option of filter.options" [value]="option.value">
          {{ option.label }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <button mat-raised-button color="primary" (click)="clearFilters()">
      <mat-icon>clear</mat-icon>
      Clear Filters
    </button>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Loading KPIs...</p>
  </div>

  <!-- KPI Table -->
  <div *ngIf="!loading" class="kpi-table-container">
    <mat-card appearance="outlined" class="kpi-card">
      <div class="table-header">
        <h3>{{ kpiLabel }} ({{ dataSource.data.length }} total)</h3>
        <button mat-icon-button class="download-button" (click)="downloadReports()">
          <mat-icon>download</mat-icon>
        </button>
      </div>

      <div class="table-content" *ngIf="dataSource.data.length > 0">
        <table mat-table [dataSource]="dataSource" class="kpi-table">
          
          <!-- Date Column -->
          <ng-container matColumnDef="date">
            <th mat-header-cell *matHeaderCellDef>Date</th>
            <td mat-cell *matCellDef="let element">
              <ng-container *ngIf="!isEditing(element)">
                {{ element.date | date:'mediumDate' }}
              </ng-container>
              <mat-form-field *ngIf="isEditing(element)" appearance="outline" class="inline-edit-field">
                <input matInput [matDatepicker]="picker" [(ngModel)]="editCache[element.id].date">
                <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
              </mat-form-field>
            </td>
          </ng-container>

          <!-- Sector Column -->
          <ng-container matColumnDef="sector">
            <th mat-header-cell *matHeaderCellDef>Sector</th>
            <td mat-cell *matCellDef="let element">
              <ng-container *ngIf="!isEditing(element)">
                <span>{{ element.sector }}</span>
              </ng-container>
              <mat-form-field *ngIf="isEditing(element)" appearance="outline" class="inline-edit-field">
                <input matInput type="string" [(ngModel)]="editCache[element.id].sector">
              </mat-form-field>
            </td>
          </ng-container>

          <!-- BCP Columns -->
          <ng-container matColumnDef="type">
            <th mat-header-cell *matHeaderCellDef>Type</th>
            <td mat-cell *matCellDef="let element">
              <ng-container *ngIf="!isEditing(element)">
                <span>{{ element.type }}</span>
              </ng-container>
              <mat-form-field *ngIf="isEditing(element)" appearance="outline" class="inline-edit-field">
                <input matInput [(ngModel)]="editCache[element.id].type">
              </mat-form-field>
            </td>
          </ng-container>

          <ng-container matColumnDef="bLs">
            <th mat-header-cell *matHeaderCellDef>BLs</th>
            <td mat-cell *matCellDef="let element">
              <ng-container *ngIf="!isEditing(element)">
                <span>{{ element.bLs }}</span>
              </ng-container>
              <mat-form-field *ngIf="isEditing(element)" appearance="outline" class="inline-edit-field">
                <input matInput [(ngModel)]="editCache[element.id].bLs">
              </mat-form-field>
            </td>
          </ng-container>

          <ng-container matColumnDef="bcPs_Reviewed">
            <th mat-header-cell *matHeaderCellDef>BCPs Reviewed</th>
            <td mat-cell *matCellDef="let element">
              <ng-container *ngIf="!isEditing(element)">
                <span>{{ element.bcPs_Reviewed }}</span>
              </ng-container>
              <mat-form-field *ngIf="isEditing(element)" appearance="outline" class="inline-edit-field">
                <input matInput type="number" [(ngModel)]="editCache[element.id].bcPs_Reviewed">
              </mat-form-field>
            </td>
          </ng-container>

          <ng-container matColumnDef="total_BCPs">
            <th mat-header-cell *matHeaderCellDef>Total BCPs</th>
            <td mat-cell *matCellDef="let element">
              <ng-container *ngIf="!isEditing(element)">
                <span>{{ element.total_BCPs }}</span>
              </ng-container>
              <mat-form-field *ngIf="isEditing(element)" appearance="outline" class="inline-edit-field">
                <input matInput type="number" [(ngModel)]="editCache[element.id].total_BCPs">
              </mat-form-field>
            </td>
          </ng-container>

          <!-- DnT Columns -->
          <ng-container matColumnDef="drillType">
            <th mat-header-cell *matHeaderCellDef>Drill Type</th>
            <td mat-cell *matCellDef="let element">
              <ng-container *ngIf="!isEditing(element)">
                <span>{{ element.drillType }}</span>
              </ng-container>
              <mat-form-field *ngIf="isEditing(element)" appearance="outline" class="inline-edit-field">
                <input matInput [(ngModel)]="editCache[element.id].drillType">
              </mat-form-field>
            </td>
          </ng-container>

          <ng-container matColumnDef="drillConducted">
            <th mat-header-cell *matHeaderCellDef>Drills Conducted</th>
            <td mat-cell *matCellDef="let element">
              <ng-container *ngIf="!isEditing(element)">
                <span>{{ element.drillConducted }}</span>
              </ng-container>
              <mat-form-field *ngIf="isEditing(element)" appearance="outline" class="inline-edit-field">
                <input matInput type="number" [(ngModel)]="editCache[element.id].drillConducted">
              </mat-form-field>
            </td>
          </ng-container>

          <ng-container matColumnDef="plannedDrills">
            <th mat-header-cell *matHeaderCellDef>Planned Drills</th>
            <td mat-cell *matCellDef="let element">
              <ng-container *ngIf="!isEditing(element)">
                <span>{{ element.plannedDrills }}</span>
              </ng-container>
              <mat-form-field *ngIf="isEditing(element)" appearance="outline" class="inline-edit-field">
                <input matInput type="number" [(ngModel)]="editCache[element.id].plannedDrills">
              </mat-form-field>
            </td>
          </ng-container>

          <ng-container matColumnDef="correctiveActions">
            <th mat-header-cell *matHeaderCellDef>Corrective Actions</th>
            <td mat-cell *matCellDef="let element">
              <ng-container *ngIf="!isEditing(element)">
                <span>{{ element.correctiveActions }}</span>
              </ng-container>
              <mat-form-field *ngIf="isEditing(element)" appearance="outline" class="inline-edit-field">
                <input matInput type="number" [(ngModel)]="editCache[element.id].correctiveActions">
              </mat-form-field>
            </td>
          </ng-container>

          <ng-container matColumnDef="correctiveType">
            <th mat-header-cell *matHeaderCellDef>Corrective Type</th>
            <td mat-cell *matCellDef="let element">
              <ng-container *ngIf="!isEditing(element)">
                <span class="status-badge">{{ element.correctiveType }}</span>
              </ng-container>
              <mat-form-field *ngIf="isEditing(element)" appearance="outline" class="inline-edit-field">
                <input matInput [(ngModel)]="editCache[element.id].correctiveType">
              </mat-form-field>
            </td>
          </ng-container>

          <!-- ERC Columns -->
          <ng-container matColumnDef="ext_Requirement_Type">
            <th mat-header-cell *matHeaderCellDef>Requirement Type</th>
            <td mat-cell *matCellDef="let element">
              <ng-container *ngIf="!isEditing(element)">
                <span>{{ element.ext_Requirement_Type }}</span>
              </ng-container>
              <mat-form-field *ngIf="isEditing(element)" appearance="outline" class="inline-edit-field">
                <input matInput [(ngModel)]="editCache[element.id].ext_Requirement_Type">
              </mat-form-field>
            </td>
          </ng-container>

          <ng-container matColumnDef="total_Requirement">
            <th mat-header-cell *matHeaderCellDef>Total Requirements</th>
            <td mat-cell *matCellDef="let element">
              <ng-container *ngIf="!isEditing(element)">
                <span>{{ element.total_Requirement }}</span>
              </ng-container>
              <mat-form-field *ngIf="isEditing(element)" appearance="outline" class="inline-edit-field">
                <input matInput type="number" [(ngModel)]="editCache[element.id].total_Requirement">
              </mat-form-field>
            </td>
          </ng-container>

          <ng-container matColumnDef="ext_Requirements">
            <th mat-header-cell *matHeaderCellDef>External Requirements</th>
            <td mat-cell *matCellDef="let element">
              <ng-container *ngIf="!isEditing(element)">
                <span>{{ element.ext_Requirements }}</span>
              </ng-container>
              <mat-form-field *ngIf="isEditing(element)" appearance="outline" class="inline-edit-field">
                <input matInput type="number" [(ngModel)]="editCache[element.id].ext_Requirements">
              </mat-form-field>
            </td>
          </ng-container>

          <!-- Common Columns -->
          <ng-container matColumnDef="createdBy">
            <th mat-header-cell *matHeaderCellDef>Created By</th>
            <td mat-cell *matCellDef="let element">
              {{ element.createdBy || 'N/A' }}
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let element">
              <div class="action-buttons compact">
                <!-- Edit Mode Actions -->
                <ng-container *ngIf="isEditing(element)">
                  <button mat-icon-button color="primary" (click)="saveEdit(element)" matTooltip="Save">
                    <mat-icon>save</mat-icon>
                  </button>
                  <button mat-icon-button color="warn" (click)="cancelEdit(element)" matTooltip="Cancel">
                    <mat-icon>cancel</mat-icon>
                  </button>
                </ng-container>
                
                <!-- Normal Mode Actions -->
                <ng-container *ngIf="!isEditing(element)">
                  <button mat-icon-button [matMenuTriggerFor]="actionsMenu" matTooltip="Actions">
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  <mat-menu #actionsMenu="matMenu">
                    <button mat-menu-item (click)="startEdit(element)">
                      <mat-icon>edit</mat-icon>
                      <span>Edit</span>
                    </button>
                  </mat-menu>
                </ng-container>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;" [class.editing-row]="isEditing(row)"></tr>
        </table>
      </div>

      <!-- No Data State -->
      <div *ngIf="dataSource.data.length === 0 && !loading" class="no-data">
        <mat-icon class="no-data-icon">assessment</mat-icon>
        <h3>No KPIs Found</h3>
        <p>No data available for the selected filters.</p>
      </div>

      <!-- Pagination -->
      <mat-paginator
        *ngIf="dataSource.data.length > 0"
        [pageSize]="pageSize"
        [pageIndex]="pageIndex"
        [length]="totalCount"
        [pageSizeOptions]="pageSizeOptions"
        (page)="onPageChange($event)"
        showFirstLastButtons>
      </mat-paginator>
    </mat-card>
  </div>
</div>