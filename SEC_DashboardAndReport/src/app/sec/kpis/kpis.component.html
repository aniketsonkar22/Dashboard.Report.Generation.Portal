<div class="kpi-page-container">
  <h2 class="page-title">KPI Management</h2>
  <p class="page-description">View and manage Key Performance Indicators</p>

  <!-- Filters Section -->
  <div class="filters-section">
    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Search KPIs</mat-label>
      <input matInput 
             [(ngModel)]="filters.name" 
             (input)="applyFilters()" 
             placeholder="Enter KPI name...">
    </mat-form-field>

    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Data Type</mat-label>
      <mat-select [(value)]="filters.dataType" (selectionChange)="applyFilters()">
        <mat-option *ngFor="let option of dataTypeOptions" [value]="option.value">
          {{ option.label }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <button mat-raised-button color="primary" (click)="clearFilters()" class="clear-button">
      Clear Filters
    </button>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Loading KPIs...</p>
  </div>

  <!-- KPI Table -->
  <div *ngIf="!loading" class="kpi-table-container">
    <mat-card appearance="outlined" class="kpi-card">
      <div class="table-header">
        <h3>KPIs ({{ totalCount }} total)</h3>
      </div>

      <div class="table-content" *ngIf="dataSource.data.length > 0">
        <table mat-table [dataSource]="dataSource" matSort class="kpi-table">
          <!-- KPI Name Column -->
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef>KPI Name</th>
            <td mat-cell *matCellDef="let kpi">
              <div class="kpi-name">
                <strong>{{ kpi.name }}</strong>
                <p class="kpi-description">{{ kpi.description }}</p>
              </div>
            </td>
          </ng-container>

          <!-- Data Type Column -->
          <ng-container matColumnDef="dataType">
            <th mat-header-cell *matHeaderCellDef>Data Type</th>
            <td mat-cell *matCellDef="let kpi">
              <span class="data-type-badge" [class]="'type-' + kpi.dataType">
                {{ kpi.dataType }}
              </span>
            </td>
          </ng-container>

          <!-- Target Value Column -->
          <ng-container matColumnDef="targetValue">
            <th mat-header-cell *matHeaderCellDef>Target Value</th>
            <td mat-cell *matCellDef="let kpi">
              <span>{{ kpi.targetValue || 0 | number:'1.2-2' }}</span>
            </td>
          </ng-container>

          <!-- Actual Value Column -->
          <ng-container matColumnDef="actualValue">
            <th mat-header-cell *matHeaderCellDef>Actual Value</th>
            <td mat-cell *matCellDef="let kpi">
              <!-- Display mode -->
              <span *ngIf="!isEditing(kpi)">{{ kpi.actualValue || 0 | number:'1.2-2' }}</span>
              
              <!-- Edit mode -->
              <div *ngIf="isEditing(kpi)" class="edit-container">
                <mat-form-field appearance="outline" class="edit-field">
                  <input matInput 
                         type="number" 
                         step="0.01"
                         [(ngModel)]="editValue"
                         placeholder="Enter actual value">
                </mat-form-field>
              </div>
            </td>
          </ng-container>

          <!-- Created Date Column -->
          <ng-container matColumnDef="createdAt">
            <th mat-header-cell *matHeaderCellDef>Created</th>
            <td mat-cell *matCellDef="let kpi">
              {{ kpi.createdAt | date:'medium' }}
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let kpi">
              <!-- Edit mode buttons -->
              <div *ngIf="!isEditing(kpi)" class="action-buttons">
                <button mat-icon-button (click)="startEdit(kpi)" matTooltip="Edit Actual Value" color="primary">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button (click)="editKpi(kpi)" matTooltip="Edit KPI Details">
                  <mat-icon>settings</mat-icon>
                </button>
                <button mat-icon-button (click)="approveKpi(kpi)" matTooltip="Approve KPI" color="primary">
                  <mat-icon>check_circle</mat-icon>
                </button>
                <button mat-icon-button (click)="rejectKpi(kpi)" matTooltip="Reject KPI" color="warn">
                  <mat-icon>cancel</mat-icon>
                </button>
                <button mat-icon-button (click)="unlockKpi(kpi)" matTooltip="Assign Deadlines" color="accent">
                  <mat-icon>schedule</mat-icon>
                </button>
              </div>
              
              <!-- Save/Cancel mode buttons -->
              <div *ngIf="isEditing(kpi)" class="action-buttons">
                <button mat-icon-button (click)="saveEdit(kpi)" matTooltip="Save" color="primary">
                  <mat-icon>check</mat-icon>
                </button>
                <button mat-icon-button (click)="cancelEdit(kpi)" matTooltip="Cancel" color="warn">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="['name', 'dataType', 'targetValue', 'actualValue', 'createdAt', 'actions']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['name', 'dataType', 'targetValue', 'actualValue', 'createdAt', 'actions'];"></tr>
        </table>
      </div>

      <!-- No Data State -->
      <div *ngIf="dataSource.data.length === 0 && !loading" class="no-data">
        <mat-icon class="no-data-icon">assessment</mat-icon>
        <h3>No KPIs Found</h3>
        <p>No KPIs are available at the moment.</p>
      </div>

      <!-- Pagination -->
      <mat-paginator
        #paginator
        *ngIf="totalCount > 0"
        [length]="totalCount"
        [pageSize]="pageSize"
        [pageIndex]="pageIndex"
        [pageSizeOptions]="pageSizeOptions"
        (page)="onPageChange($event)"
        showFirstLastButtons
        [hidePageSize]="false">
      </mat-paginator>
    </mat-card>
  </div>
</div>